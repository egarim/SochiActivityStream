@using SocialKit.Components.Abstractions
@using SocialKit.Components.Components.Common
@inject ICurrentUserService CurrentUser
@inject NavigationManager Navigation
@implements IDisposable

<nav class="x-top-nav" aria-label="Primary navigation">
        <div class="x-top-nav__content">
            <a class="x-top-nav__brand" href="/">
                <i class="fas fa-bolt"></i>
                <span>BlazorBook</span>
            </a>

            @if (CurrentUser.IsAuthenticated)
            {
                <div class="x-top-nav__search" role="search">
                    <input type="text" 
                           @bind="searchQuery" 
                           @bind:event="oninput"
                           @onkeydown="HandleSearchKeyDown"
                           placeholder="Search topics, people, or posts" 
                           aria-label="Search" />
                </div>
            }

            <div class="x-top-nav__actions">
                @if (CurrentUser.IsAuthenticated)
                {
                    <a class="x-top-nav__action" href="/" aria-label="Home">
                        <i class="fas fa-home"></i>
                    </a>
                    <a class="x-top-nav__action" href="/friends" aria-label="Friends">
                        <i class="fas fa-user-friends"></i>
                    </a>
                    <a class="x-top-nav__action" href="/messages" aria-label="Messages">
                        <i class="fas fa-comment-dots"></i>
                    </a>
                    <a class="x-top-nav__action x-top-nav__avatar" href="/profile/@CurrentUser.ProfileId" aria-label="My profile">
                        <Avatar ImageUrl="@CurrentUser.AvatarUrl"
                                Name="@CurrentUser.DisplayName"
                                Size="AvatarSize.Medium" />
                    </a>
                    <a class="x-top-nav__cta x-top-nav__cta--ghost" href="/logout">Log Out</a>
                }
                else
                {
                    <a class="x-top-nav__cta x-top-nav__cta--ghost" href="/login">Log In</a>
                    <a class="x-top-nav__cta" href="/signup">Sign Up</a>
                }
            </div>
        </div>
    </nav>

@code {
    private string searchQuery = string.Empty;

    protected override void OnInitialized()
    {
        CurrentUser.OnAuthStateChanged += HandleAuthStateChanged;
    }
    
    private void HandleAuthStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(searchQuery))
        {
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
            searchQuery = string.Empty;
        }
    }
    
    public void Dispose()
    {
        CurrentUser.OnAuthStateChanged -= HandleAuthStateChanged;
    }
}

