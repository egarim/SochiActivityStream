@* Create Post Component using MudBlazor + DevExpress *@

<MudCard Class="sk-create-post mb-3" Elevation="2">
    <MudCardContent>
        <div class="d-flex align-items-start gap-2">
            <Avatar ImageUrl="@UserAvatar" 
                    Name="@UserName" 
                    Size="AvatarSize.Medium" />
            <MudTextField @bind-Value="@Text"
                          id="post-content"
                          Lines="2"
                          Variant="Variant.Outlined"
                          Placeholder="@($"What's on your mind, {FirstName}?")"
                          Disabled="@IsPosting"
                          Class="flex-grow-1" />
        </div>
        
        @* Image Thumbnail Preview Grid *@
        @if (_selectedFiles.Count > 0)
        {
            <div class="mt-3">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var file in _selectedFiles)
                    {
                        <div class="position-relative" style="width: 100px; height: 100px;">
                            <img src="@file.PreviewUrl" 
                                 alt="@file.Name"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;" />
                            <MudIconButton Icon="@Icons.Material.Filled.Close"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           Class="position-absolute"
                                           Style="top: -8px; right: -8px; background: white; border-radius: 50%; padding: 2px; width: 20px; height: 20px;"
                                           OnClick="@(() => RemoveFile(file))" />
                        </div>
                    }
                </div>
                <MudText Typo="Typo.caption" Class="mt-1 text-muted">@_selectedFiles.Count image(s) selected</MudText>
            </div>
        }
    </MudCardContent>
    
    <MudDivider />
    
    <MudCardActions Class="d-flex justify-content-between px-3">
        <div class="d-flex gap-2">
            <DxFileInput @ref="_fileInput"
                         FilesUploading="@OnFilesUploading"
                         SelectedFilesChanged="@OnSelectedFilesChanged"
                         AllowMultiFileUpload="true"
                         MaxFileCount="10"
                         MaxFileSize="@(10 * 1024 * 1024)"
                         AllowedFileExtensions="@(new List<string> { ".jpg", ".jpeg", ".png", ".gif", ".webp" })"
                         UploadMode="UploadMode.Instant"
                         Visible="false"
                         ExternalSelectButtonCssSelector="#photo-select-btn" />
            <MudButton Id="photo-select-btn"
                       StartIcon="@Icons.Material.Filled.Image"
                       Variant="Variant.Text"
                       Size="Size.Small"
                       Disabled="@IsPosting">
                Photo/Video
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.PersonAdd"
                       Variant="Variant.Text"
                       Size="Size.Small"
                       Disabled="true">Tag</MudButton>
        </div>
        <MudButton id="post-button"
                   StartIcon="@Icons.Material.Filled.Send"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Size="Size.Small"
                   Disabled="@(!CanPost)"
                   OnClick="HandlePost">
            @if (IsPosting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                <span>Posting...</span>
            }
            else
            {
                <span>Post</span>
            }
        </MudButton>
    </MudCardActions>
</MudCard>

@code {
    [Parameter] public string? UserAvatar { get; set; }
    [Parameter] public string? UserName { get; set; }
    [Parameter] public EventCallback<CreatePostData> OnPost { get; set; }
    [Parameter] public bool IsPosting { get; set; }
    
    private DxFileInput? _fileInput;
    private string Text { get; set; } = "";
    private List<SelectedFile> _selectedFiles = new();
    
    private string FirstName => UserName?.Split(' ').FirstOrDefault() ?? "friend";
    
    private bool CanPost => (!string.IsNullOrWhiteSpace(Text) || _selectedFiles.Count > 0) && !IsPosting;
    
    private void OnSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        // Files are added via FilesUploading event
        StateHasChanged();
    }
    
    private async Task OnFilesUploading(FilesUploadingEventArgs args)
    {
        foreach (var file in args.Files)
        {
            if (file.Size > 10 * 1024 * 1024)
                continue;
                
            // Read file data
            using var stream = new MemoryStream();
            await file.OpenReadStream(file.Size).CopyToAsync(stream);
            var buffer = stream.ToArray();
            var base64 = Convert.ToBase64String(buffer);
            var previewUrl = $"data:{file.Type};base64,{base64}";
            
            _selectedFiles.Add(new SelectedFile
            {
                Name = file.Name,
                ContentType = file.Type,
                Size = (long)file.Size,
                Data = buffer,
                PreviewUrl = previewUrl
            });
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    private void RemoveFile(SelectedFile file)
    {
        _selectedFiles.Remove(file);
    }
    
    private async Task HandlePost()
    {
        if (!CanPost) return;
        
        var postData = new CreatePostData
        {
            Text = Text,
            Files = _selectedFiles.ToList()
        };
        
        Text = "";
        _selectedFiles.Clear();
        StateHasChanged();
        
        if (OnPost.HasDelegate)
            await OnPost.InvokeAsync(postData);
    }
    
    public class SelectedFile
    {
        public string Name { get; set; } = "";
        public string ContentType { get; set; } = "";
        public long Size { get; set; }
        public byte[] Data { get; set; } = Array.Empty<byte>();
        public string PreviewUrl { get; set; } = "";
    }
    
    public class CreatePostData
    {
        public string Text { get; set; } = "";
        public List<SelectedFile> Files { get; set; } = new();
    }
}
