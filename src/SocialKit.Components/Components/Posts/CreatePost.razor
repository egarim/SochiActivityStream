@* Create Post Component using MudBlazor + DevExpress *@

<MudCard Class="sk-create-post mb-3" Elevation="2">
    <MudCardContent>
        <div class="d-flex align-items-start gap-2">
            <Avatar ImageUrl="@UserAvatar" 
                    Name="@UserName" 
                    Size="AvatarSize.Medium" />
            <MudTextField @bind-Value="@Text"
                          id="post-content"
                          Lines="2"
                          Variant="Variant.Outlined"
                          Placeholder="@($"What's on your mind, {FirstName}?")"
                          Disabled="@IsPosting"
                          Class="flex-grow-1" />
        </div>
        
        @* Image Carousel Preview Section *@
        @if (_selectedFiles.Count > 0)
        {
            <div class="mt-3">
                @if (_selectedFiles.Count == 1)
                {
                    <div class="position-relative" style="max-height: 300px; overflow: hidden;">
                        <img src="@_selectedFiles[0].PreviewUrl" 
                             alt="@_selectedFiles[0].Name"
                             style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       Class="position-absolute"
                                       Style="top: 8px; right: 8px; background: white; border-radius: 50%;"
                                       OnClick="@(() => RemoveFile(_selectedFiles[0]))" />
                    </div>
                }
                else
                {
                    <div class="position-relative">
                        <DxCarousel Width="100%"
                                    Height="300px"
                                    Data="@_carouselData"
                                    ImageSrcField="Src"
                                    ImageAltField="Alt"
                                    ImageSizeMode="CarouselImageSizeMode.FitProportional"
                                    LoopNavigationEnabled="true"
                                    NavButtonsDisplayMode="CarouselControlsDisplayMode.VisibleOnHover"
                                    PagerDisplayMode="CarouselControlsDisplayMode.AlwaysVisible"
                                    ActiveItemIndex="@_activeImageIndex"
                                    ActiveItemIndexChanged="@((int idx) => _activeImageIndex = idx)">
                        </DxCarousel>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       Class="position-absolute"
                                       Style="top: 8px; right: 8px; background: white; border-radius: 50%; z-index: 10;"
                                       OnClick="@RemoveCurrentFile" />
                        <div class="text-center mt-2">
                            <MudText Typo="Typo.caption">@(_activeImageIndex + 1) / @_selectedFiles.Count images</MudText>
                        </div>
                    </div>
                }
            </div>
        }
    </MudCardContent>
    
    <MudDivider />
    
    <MudCardActions Class="d-flex justify-content-between px-3">
        <div class="d-flex gap-2">
            <DxFileInput @ref="_fileInput"
                         FilesUploading="@OnFilesUploading"
                         SelectedFilesChanged="@OnSelectedFilesChanged"
                         AllowMultiFileUpload="true"
                         MaxFileCount="10"
                         MaxFileSize="@(10 * 1024 * 1024)"
                         AllowedFileExtensions="@(new List<string> { ".jpg", ".jpeg", ".png", ".gif", ".webp" })"
                         UploadMode="UploadMode.Instant"
                         Visible="false"
                         ExternalSelectButtonCssSelector="#photo-select-btn" />
            <MudButton Id="photo-select-btn"
                       StartIcon="@Icons.Material.Filled.Image"
                       Variant="Variant.Text"
                       Size="Size.Small"
                       Disabled="@IsPosting">
                Photo/Video
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.PersonAdd"
                       Variant="Variant.Text"
                       Size="Size.Small"
                       Disabled="true">Tag</MudButton>
        </div>
        <MudButton id="post-button"
                   StartIcon="@Icons.Material.Filled.Send"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Size="Size.Small"
                   Disabled="@(!CanPost)"
                   OnClick="HandlePost">
            @if (IsPosting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                <span>Posting...</span>
            }
            else
            {
                <span>Post</span>
            }
        </MudButton>
    </MudCardActions>
</MudCard>

@code {
    [Parameter] public string? UserAvatar { get; set; }
    [Parameter] public string? UserName { get; set; }
    [Parameter] public EventCallback<CreatePostData> OnPost { get; set; }
    [Parameter] public bool IsPosting { get; set; }
    
    private DxFileInput? _fileInput;
    private string Text { get; set; } = "";
    private List<SelectedFile> _selectedFiles = new();
    private List<CarouselImageData> _carouselData = new();
    private int _activeImageIndex = 0;
    
    private string FirstName => UserName?.Split(' ').FirstOrDefault() ?? "friend";
    
    private bool CanPost => (!string.IsNullOrWhiteSpace(Text) || _selectedFiles.Count > 0) && !IsPosting;
    
    private void OnSelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        // Files are added via FilesUploading event
        StateHasChanged();
    }
    
    private async Task OnFilesUploading(FilesUploadingEventArgs args)
    {
        foreach (var file in args.Files)
        {
            if (file.Size > 10 * 1024 * 1024)
                continue;
                
            // Read file data
            using var stream = new MemoryStream();
            await file.OpenReadStream(file.Size).CopyToAsync(stream);
            var buffer = stream.ToArray();
            var base64 = Convert.ToBase64String(buffer);
            var previewUrl = $"data:{file.Type};base64,{base64}";
            
            _selectedFiles.Add(new SelectedFile
            {
                Name = file.Name,
                ContentType = file.Type,
                Size = (long)file.Size,
                Data = buffer,
                PreviewUrl = previewUrl
            });
        }
        
        UpdateCarouselData();
        await InvokeAsync(StateHasChanged);
    }
    
    private void UpdateCarouselData()
    {
        _carouselData = _selectedFiles.Select(f => new CarouselImageData
        {
            Src = f.PreviewUrl,
            Alt = f.Name
        }).ToList();
    }
    
    private void RemoveFile(SelectedFile file)
    {
        _selectedFiles.Remove(file);
        UpdateCarouselData();
        if (_activeImageIndex >= _selectedFiles.Count && _selectedFiles.Count > 0)
        {
            _activeImageIndex = _selectedFiles.Count - 1;
        }
    }
    
    private void RemoveCurrentFile()
    {
        if (_selectedFiles.Count > 0 && _activeImageIndex < _selectedFiles.Count)
        {
            _selectedFiles.RemoveAt(_activeImageIndex);
            UpdateCarouselData();
            if (_activeImageIndex >= _selectedFiles.Count && _selectedFiles.Count > 0)
            {
                _activeImageIndex = _selectedFiles.Count - 1;
            }
        }
    }
    
    private async Task HandlePost()
    {
        if (!CanPost) return;
        
        var postData = new CreatePostData
        {
            Text = Text,
            Files = _selectedFiles.ToList()
        };
        
        Text = "";
        _selectedFiles.Clear();
        _carouselData.Clear();
        _activeImageIndex = 0;
        StateHasChanged();
        
        if (OnPost.HasDelegate)
            await OnPost.InvokeAsync(postData);
    }
    
    public class SelectedFile
    {
        public string Name { get; set; } = "";
        public string ContentType { get; set; } = "";
        public long Size { get; set; }
        public byte[] Data { get; set; } = Array.Empty<byte>();
        public string PreviewUrl { get; set; } = "";
    }
    
    public class CreatePostData
    {
        public string Text { get; set; } = "";
        public List<SelectedFile> Files { get; set; } = new();
    }
    
    public class CarouselImageData
    {
        public string Src { get; set; } = "";
        public string Alt { get; set; } = "";
    }
}
