@* Post Card Component using MudBlazor *@
@using Content.Abstractions

<MudCard Class="sk-post-card mb-3" Elevation="2">
    <MudCardHeader>
        <CardHeaderAvatar>
            <a href="/profile/@Post.Author?.Id" class="text-decoration-none">
                <Avatar ImageUrl="@Post.Author?.ImageUrl" 
                        Name="@Post.Author?.DisplayName" 
                        Size="AvatarSize.Medium" />
            </a>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <a href="/profile/@Post.Author?.Id" class="fw-semibold text-decoration-none">
                @(Post.Author?.DisplayName ?? "Unknown User")
            </a>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">@FormatTime(Post.CreatedAt)</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" />
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudText>@Post.Body</MudText>
        
        @if (HasReactions || Post.CommentCount > 0)
        {
            <div class="d-flex justify-content-between mt-2 mud-text-secondary">
                @if (HasReactions)
                {
                    <span>
                        <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Size="Size.Small" Color="Color.Primary" />
                        @TotalReactions
                    </span>
                }
                @if (Post.CommentCount > 0)
                {
                    <span>@Post.CommentCount comments</span>
                }
            </div>
        }
    </MudCardContent>
    
    <MudDivider />
    
    <MudCardActions Class="d-flex justify-content-around">
        <MudButton id="like-button"
                   StartIcon="@(IsLiked ? Icons.Material.Filled.ThumbUp : Icons.Material.Outlined.ThumbUp)"
                   Color="@(IsLiked ? Color.Primary : Color.Default)"
                   Variant="Variant.Text"
                   Size="Size.Small"
                   Class="flex-grow-1"
                   Disabled="@IsLoading"
                   OnClick="OnLikeClick">Like</MudButton>
        <MudButton id="comment-button"
                   StartIcon="@Icons.Material.Outlined.Comment"
                   Variant="Variant.Text"
                   Size="Size.Small"
                   Class="flex-grow-1"
                   OnClick="OnCommentClick">Comment</MudButton>
        <MudButton id="share-button"
                   StartIcon="@Icons.Material.Outlined.Share"
                   Variant="Variant.Text"
                   Size="Size.Small"
                   Class="flex-grow-1">Share</MudButton>
    </MudCardActions>
</MudCard>

@code {
    [Parameter, EditorRequired] public PostDto Post { get; set; } = null!;
    [Parameter] public string? CurrentUserAvatar { get; set; }
    [Parameter] public string? CurrentUserName { get; set; }
    [Parameter] public EventCallback<PostDto> OnLike { get; set; }
    [Parameter] public EventCallback<PostDto> OnComment { get; set; }
    [Parameter] public EventCallback<PostDto> OnShare { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    
    private bool ShowComments { get; set; }
    
    private bool IsLiked => Post.ViewerReaction == ReactionType.Like;
    private int LikeCount => Post.ReactionCounts.TryGetValue(ReactionType.Like, out var count) ? count : 0;
    private int TotalReactions => Post.ReactionCounts.Values.Sum();
    private bool HasReactions => TotalReactions > 0;
    
    private async Task OnLikeClick()
    {
        if (OnLike.HasDelegate)
            await OnLike.InvokeAsync(Post);
    }
    
    private void OnCommentClick()
    {
        ShowComments = !ShowComments;
    }
    
    private string FormatTime(DateTimeOffset dateTime)
    {
        var diff = DateTimeOffset.UtcNow - dateTime;
        
        if (diff.TotalSeconds < 60) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d";
        if (diff.TotalDays < 365) return dateTime.ToString("MMM d");
        
        return dateTime.ToString("MMM d, yyyy");
    }
}
